<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer@latest/dist/artplayer.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #container {
            width: 100%;
            height: 100%;
            display: flex;
            background: #000;
        }
        #playlist {
            width: 300px;
            background: #1a1a1a;
            color: #fff;
            overflow-y: auto;
            padding: 10px;
        }
        #player-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .artplayer-app {
            width: 100%;
            max-width: 1200px;
            aspect-ratio: 16/9;
        }
        .episode-item {
            padding: 10px;
            margin: 5px 0;
            background: #333;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
        }
        .episode-item:hover {
            background: #444;
        }
        .episode-item.active {
            background: #23ade5;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="playlist">
            <h3 style="color:#fff; margin-bottom:15px;">播放列表</h3>
            <div id="episode-list"></div>
        </div>
        <div id="player-container">
            <div class="artplayer-app"></div>
        </div>
    </div>

    <script>
        // 等待所有资源加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化播放器
            const art = new Artplayer({
                container: '.artplayer-app',
                url: '{video_url}',
                autoplay: true,
                isLive: false,
                muted: false,
                pip: true,
                autoSize: true,
                autoMini: true,
                screenshot: true,
                setting: true,
                loop: true,
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                fullscreen: true,
                fullscreenWeb: true,
                subtitleOffset: true,
                miniProgressBar: true,
                mutex: true,
                backdrop: true,
                playsInline: true,
                autoPlayback: true,
                airplay: true,
                theme: '#23ade5',
                customType: {
                    m3u8: function(video, url, art) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                            art.on('destroy', () => hls.destroy());
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        } else {
                            art.notice.show = '不支持播放m3u8格式';
                        }
                    }
                },
                controls: [
                    {
                        position: 'right',
                        html: '选集',
                        click: function () {
                            art.fullscreen = !art.fullscreen;

                        },
                    },
                ],

            });

            // 存储播放器实例
            window.artplayer = art;

            // 初始化播放列表
            updatePlaylist({video_list_json});

            // 播放器准备就绪回调
            art.on('ready', () => {
                if (window.pywebview && window.pywebview.api) {
                    window.pywebview.api.onPlayerReady();
                }
            });
            art.on('fullscreen', (state) => {
                window.pywebview.api.onFullscreen(state);
                console.info('fullscreen', state);
            });
        });

        // 更新播放列表
        function updatePlaylist(data) {
            const listElement = document.getElementById('episode-list');
            listElement.innerHTML = '';

            data.forEach((episode, index) => {
                const item = document.createElement('div');
                item.className = 'episode-item';
                item.textContent = episode.title;
                item.onclick = function() {
                    // 更新当前选中项样式
                    document.querySelectorAll('.episode-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');

                    // 播放选中剧集
                    playEpisode(episode, index);
                };
                listElement.appendChild(item);
            });
        }

        // 播放指定剧集
        function playEpisode(episode, index) {
            if (window.artplayer) {
                window.artplayer.switchUrl(episode.url);
                window.artplayer.play();

                // 通知Python端
                if (window.pywebview && window.pywebview.api) {
                    window.pywebview.api.playEpisode(index);
                }
            }
        }
    </script>
</body>
</html>
